!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@ionic-native/deeplinks/ngx"),require("@ionic/angular"),require("@auth0/angular-jwt"),require("@angular/common/http"),require("@ionic-native/browser-tab/ngx"),require("keycloak-js"),require("@ionic-native/in-app-browser/ngx"),require("@angular/router"),require("@ionic-native/native-storage/ngx")):"function"==typeof define&&define.amd?define("@cmotion/ionic-keycloak-auth",["exports","@angular/core","rxjs","rxjs/operators","@ionic-native/deeplinks/ngx","@ionic/angular","@auth0/angular-jwt","@angular/common/http","@ionic-native/browser-tab/ngx","keycloak-js","@ionic-native/in-app-browser/ngx","@angular/router","@ionic-native/native-storage/ngx"],t):t(((e=e||self).cmotion=e.cmotion||{},e.cmotion["ionic-keycloak-auth"]={}),e.ng.core,e.rxjs,e.rxjs.operators,e.deepLink,e.ionicAngular,e.angularJwt,e.ng.common.http,e.browserTab,e.Keycloak_,e.appBrowser,e.ng.router,e.storage)}(this,function(e,t,n,r,o,i,s,c,a,u,l,p,h){"use strict";var f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function d(e,t,n,r){return new(n||(n=Promise))(function(o,i){function s(e){try{a(r.next(e))}catch(e){i(e)}}function c(e){try{a(r.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(s,c)}a((r=r.apply(e,t||[])).next())})}function v(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function y(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}var k=new t.InjectionToken("DEEP_LINKING_OPTIONS"),g=new t.InjectionToken("JWT_GET_AND_SETTER"),b=new t.InjectionToken("KEYCLOAK_OPTIONS");var w=function(){};var T=function(){};var m=function(){};var I=function(){function e(e,t){this.navController=e,this.deepLinks=t,this.paramsSubject=new n.Subject}return e.prototype.params=function(){return this.paramsSubject.pipe(r.filter(function(e){return!!e}))},e.prototype.init=function(){var e=this;this.deepLinks.route({}).subscribe(function(t){e.extractData(t.$link)},function(t){e.extractData(t.$link)})},e.prototype.extractData=function(e){if(e){e.path;var t=e.fragment;e.host,e.scheme,e.url;if(this.containsCode(t)){var n=this.extractCode(t);this.nextParams(n.code)}}},e.prototype.extractCode=function(e){var t=e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var n,r=y(t.split("="),2),o=r[0],i=r[1];return Object.assign(e,((n={})[o]=decodeURIComponent(i),n))},{});if(t&&t.code)return t.code=t.code.split("#")[0],t},e.prototype.nextParams=function(e){this.paramsSubject.next(e)},e.prototype.containsCode=function(e){return!!e&&e.indexOf("code")>-1},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:i.NavController},{type:o.Deeplinks}]},e}();var j=function(){function e(e){this.config=e}return e.prototype.setToken=function(e){return d(this,void 0,void 0,function(){return v(this,function(t){return[2,this.config.setToken(e)]})})},e.prototype.getToken=function(){return d(this,void 0,void 0,function(){return v(this,function(e){return[2,this.config.getToken()]})})},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:[g]}]}]},e}();var x=u,S=new s.JwtHelperService,_=function(){function e(e,t,n,r,o,i,s,c){this.http=n,this.browserTab=r,this.router=o,this.storage=i,this.inAppBrowser=s,this.deepLinkService=c,this.scope=t.scope,this.keycloakConfig=t.jsonConfig,this.appPrefix=e.deepLinkingScheme+"://app"}return e.prototype.user=function(){return this.subject||(this.subject=new n.BehaviorSubject(null)),this.subject.asObservable()},e.prototype.init=function(){return d(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.initKeycloak()];case 1:return e.sent(),[2,this.refresh()]}})})},e.prototype.logout=function(){return d(this,void 0,void 0,function(){var e,t=this;return v(this,function(n){switch(n.label){case 0:return[4,this.handleNewToken(null)];case 1:return n.sent(),e=this.getLogoutUrl(),[2,new Promise(function(n,r){return d(t,void 0,void 0,function(){var t,o,i=this;return v(this,function(s){switch(s.label){case 0:return[4,this.browserTab.isAvailable()];case 1:return s.sent()?(this.browserTab.openUrl(e).then(function(){return i.browserTab.close()}).catch(function(e){return r(e)}),n()):(t=this.inAppBrowser.create(e,"_system"),o=t.on("loadstop").subscribe(function(){t.close(),n(),o.unsubscribe()},function(e){r(e),o.unsubscribe()})),[2]}})})})]}})})},e.prototype.login=function(e,t){return void 0===e&&(e=!0),d(this,void 0,void 0,function(){var n,r,o;return v(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),"/"===t[0]&&(t=t.substr(1)),[4,this.beginLoginAndGetCode(t,e)];case 1:return n=i.sent(),[2,this.continueLoginWithCode(n)];case 2:throw r=i.sent(),o={messageError:"Ionic Keycloak Error: error by login"},Object.assign(r,{context:o}),r;case 3:return[2]}})})},e.prototype.getToken=function(e){return void 0===e&&(e=!1),d(this,void 0,void 0,function(){var t;return v(this,function(n){switch(n.label){case 0:return[4,this.storage.getToken()];case 1:return(t=n.sent())?e||S.isTokenExpired(t.access_token,10)?[4,this.refresh()]:[3,3]:[2,null];case 2:t=n.sent(),n.label=3;case 3:return[2,t.access_token]}})})},e.prototype.getTokenDecoded=function(e){return void 0===e&&(e=!1),d(this,void 0,void 0,function(){var t;return v(this,function(n){switch(n.label){case 0:return[4,this.getToken(e)];case 1:return t=n.sent(),[2,S.decodeToken(t)]}})})},e.prototype.getLogoutUrl=function(e){return void 0===e&&(e=this.router.url),this.keycloakInstance.createLogoutUrl({redirectUri:this.appPrefix+encodeURIComponent(e)})},e.prototype.getKcJsonStructure=function(){return d(this,void 0,void 0,function(){var e,t;return v(this,function(n){switch(n.label){case 0:return(e=this.keycloakConfig())instanceof Promise?[4,e]:[3,2];case 1:return t=n.sent(),[3,3];case 2:t=e,n.label=3;case 3:return t.clientId=t.resource,t.url=t["auth-server-url"],[2,t]}})})},e.prototype.handleNewToken=function(e){return d(this,void 0,void 0,function(){var t;return v(this,function(r){switch(r.label){case 0:return e?(t=S.decodeToken(e.id_token||e.access_token),this.subject||(this.subject=new n.BehaviorSubject(t)),this.subject.next(t),[4,this.storage.setToken(e)]):[3,2];case 1:return r.sent(),[3,4];case 2:return this.subject||(this.subject=new n.BehaviorSubject(null)),this.subject.next(null),[4,this.storage.setToken(null)];case 3:r.sent(),r.label=4;case 4:return[2]}})})},e.prototype.createPostRequest=function(e,t,n){return this.http.post(e,t,n).toPromise()},e.prototype.getRefreshParams=function(e){var t=(new c.HttpParams).set("grant_type","refresh_token").set("refresh_token",e).set("client_id",encodeURIComponent(this.keycloakInstance.clientId)),n=this.keycloakInstance.clientSecret;return n?t.set("client_secret",encodeURIComponent(n)):t},e.prototype.getAccessTokenParams=function(e,t){var n=(new c.HttpParams).set("grant_type","authorization_code").set("code",e).set("client_id",encodeURIComponent(this.keycloakInstance.clientId)).set("redirect_uri",t);(this.scope||this.actualKeycloakConfig&&this.actualKeycloakConfig.scope)&&(n=n.set("scope",this.scope||this.actualKeycloakConfig.scope));var r=this.keycloakInstance.clientSecret;return r&&(n=n.set("client_secret",encodeURIComponent(r))),n},e.prototype.getTokenRequestHeaders=function(){var e=(new c.HttpHeaders).set("Content-Type","application/x-www-form-urlencoded"),t=this.keycloakInstance.clientSecret,n=this.keycloakInstance.clientId;return n&&t&&e.set("Authorization","Basic "+btoa(n+":"+t)),e},e.prototype.refresh=function(){return d(this,void 0,void 0,function(){var e,t,n,r;return v(this,function(o){switch(o.label){case 0:return o.trys.push([0,4,,6]),[4,this.storage.getToken()];case 1:return(e=o.sent())?this.isValidToken(e)?[3,3]:(t=this.getTokenUrl(),n=this.getTokenRequestHeaders(),r=this.getRefreshParams(e.refresh_token),[4,this.createPostRequest(t,r,{headers:n})]):[3,3];case 2:e=o.sent(),o.label=3;case 3:return this.handleNewToken(e),[2,e];case 4:return o.sent(),[4,this.logout()];case 5:return o.sent(),[2,null];case 6:return[2]}})})},e.prototype.getTokenUrl=function(){return this.keycloakInstance.authServerUrl+"/realms/"+this.keycloakInstance.realm+"/protocol/openid-connect/token"},e.prototype.isValidToken=function(e){return!!e&&S.isTokenExpired(e.access_token,10)},e.prototype.initKeycloakInstance=function(){return d(this,void 0,void 0,function(){var e;return v(this,function(t){switch(t.label){case 0:return[4,this.getKcJsonStructure()];case 1:return e=t.sent(),this.actualKeycloakConfig=e,this.keycloakInstance=x(e),[2]}})})},e.prototype.initKeycloak=function(){return d(this,void 0,void 0,function(){return v(this,function(e){switch(e.label){case 0:return[4,this.initKeycloakInstance()];case 1:return e.sent(),this.keycloakInstance.init({adapter:"cordova-native",redirectUri:this.appPrefix+"/"}),[2]}})})},e.prototype.beginLoginAndGetCode=function(e,t){return void 0===t&&(t=!0),d(this,void 0,void 0,function(){var n,r,o=this;return v(this,function(i){switch(i.label){case 0:return e=this.appPrefix+"/"+e,[4,this.storage.setToken(null)];case 1:return i.sent(),n={redirectUri:e},r=t?this.keycloakInstance.createLoginUrl(n):this.keycloakInstance.createRegisterUrl(n),[4,this.browserTab.isAvailable()];case 2:return i.sent()?this.browserTab.openUrl(r):this.inAppBrowser.create(r,"_system"),[2,new Promise(function(t,n){var r=o.deepLinkService.params().subscribe(function(n){t({code:n,redirectUri:e}),r.unsubscribe()},function(e){n(e),r.unsubscribe()})})]}})})},e.prototype.continueLoginWithCode=function(e){var t=e.code,n=e.redirectUri;return d(this,void 0,void 0,function(){var e,r,o,i=this;return v(this,function(s){return this.browserTab.close().catch(function(e){void 0===e&&(e={});var t={message:"Error while closing the browser"};throw console.log(t.message,e),Object.assign(e,{context:t}),e}),e=this.getTokenUrl(),r=this.getAccessTokenParams(t,n),o=this.getTokenRequestHeaders(),[2,this.createPostRequest(e,r,{headers:o}).then(function(e){return d(i,void 0,void 0,function(){return v(this,function(t){return this.handleNewToken(e),[2,e]})})})]})})},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:w,decorators:[{type:t.Inject,args:[k]}]},{type:T,decorators:[{type:t.Inject,args:[b]}]},{type:c.HttpClient},{type:a.BrowserTab},{type:p.Router},{type:j},{type:l.InAppBrowser},{type:I}]},e}();var P=function(e){function n(t,n){var r=e.call(this,t,new s.JwtHelperService)||this;return r.config=t,r.keycloakAuthService=n,r.initTokenGetter(),r}return function(e,t){function n(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(n,e),n.prototype.initTokenGetter=function(){var e=this;this.tokenGetter=function(){return e.keycloakAuthService.getToken()}},n.decorators=[{type:t.Injectable}],n.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:[g]}]},{type:_}]},n}(s.JwtInterceptor);var C=function(){function e(e,t,n,r){var o=this;if(this.platform=e,this.authService=t,this.deepLinkService=n,r)throw new Error("JwtModule is already loaded. It should only be imported in your application's main module.");this.platform.ready().then(function(){return o.authService.init()}).then(function(){return o.deepLinkService.init()}).catch(function(e){void 0===e&&(e={});throw Object.assign(e,{context:{messageError:"Ionic Keycloak Error: could not initialize the app"}}),e})}return e.forRoot=function(t){return void 0===t&&(t=new m),{ngModule:e,providers:[o.Deeplinks,a.BrowserTab,l.InAppBrowser,h.NativeStorage,c.HttpClientModule,t.kcOptionsProvider||{provide:b,useValue:t.keycloakConfig},t.jwtConfigProvider||{provide:g,useValue:t.jwtModuleOptions},{provide:k,useValue:t.deepLinksConfig},j,I,_,s.JwtHelperService,{provide:c.HTTP_INTERCEPTORS,useClass:P,multi:!0}]}},e.decorators=[{type:t.NgModule}],e.ctorParameters=function(){return[{type:i.Platform},{type:_},{type:I},{type:e,decorators:[{type:t.Optional},{type:t.SkipSelf}]}]},e}();e.DEEP_LINKING_OPTIONS=k,e.DeepLinkConfig=w,e.DeepLinkService=I,e.IonicKeycloakAuthModule=C,e.JWT_GET_AND_SETTER=g,e.KEYCLOAK_OPTIONS=b,e.KcConfig=T,e.KcTokenInterceptorService=P,e.KeycloakAuthService=_,e.ModuleConfig=m,e.StorageService=j,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=cmotion-ionic-keycloak-auth.umd.min.js.map