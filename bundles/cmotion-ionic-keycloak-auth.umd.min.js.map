{"version":3,"sources":["../../../../node_modules/tslib/tslib.es6.js","ng://@cmotion/ionic-keycloak-auth/lib/contant/deep-linking-config-injection-token.ts","ng://@cmotion/ionic-keycloak-auth/lib/contant/jwt-injection-token.ts","ng://@cmotion/ionic-keycloak-auth/lib/contant/kc-injection-token.ts","ng://@cmotion/ionic-keycloak-auth/lib/model/deep-link-config.ts","ng://@cmotion/ionic-keycloak-auth/lib/model/kc-config.ts","ng://@cmotion/ionic-keycloak-auth/lib/model/module-config.ts","ng://@cmotion/ionic-keycloak-auth/lib/service/deep-link.service.ts","ng://@cmotion/ionic-keycloak-auth/lib/service/storage.service.ts","ng://@cmotion/ionic-keycloak-auth/lib/service/keycloak-auth.service.ts","ng://@cmotion/ionic-keycloak-auth/lib/service/kc-token-interceptor.service.ts","ng://@cmotion/ionic-keycloak-auth/lib/ionic-keycloak-auth.module.ts"],"names":["extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","__generator","body","f","y","t","g","_","label","sent","trys","ops","verb","throw","return","Symbol","iterator","this","n","v","op","TypeError","call","pop","length","push","__read","o","m","r","i","ar","error","DEEP_LINKING_OPTIONS","InjectionToken","JWT_GET_AND_SETTER","KEYCLOAK_OPTIONS","DeepLinkConfig","KcConfig","ModuleConfig","DeepLinkService","navController","deepLinks","paramsSubject","Subject","prototype","params","pipe","filter","str","init","_this","route","subscribe","match","extractData","$link","nomatch","path","fragment","host","scheme","url","containsCode","extractCode","nextParams","code","paramsObj","slice","indexOf","split","reduce","hash","_b","key","val","assign","_a","decodeURIComponent","Injectable","NavController","Deeplinks","StorageService","config","setToken","getToken","Inject","args","Keycloak","Keycloak_","jwtHelperService","JwtHelperService","KeycloakAuthService","deepLinkConfig","kcConfig","http","browserTab","router","storage","inAppBrowser","deepLinkService","scope","keycloakConfig","jsonConfig","appPrefix","deepLinkingScheme","user","subject","BehaviorSubject","asObservable","initKeycloak","refresh","logout","handleNewToken","getLogoutUrl","isAvailable","openUrl","close","catch","err","browser_1","create","sub_1","on","unsubscribe","login","isLogin","redirectUrl","substr","beginLoginAndGetCode","response","continueLoginWithCode","context","messageError","err_1","authToken","isTokenExpired","access_token","getTokenDecoded","token","decodeToken","keycloakInstance","createLogoutUrl","redirectUri","encodeURIComponent","getKcJsonStructure","prom","clientId","resource","id_token","createPostRequest","uri","options","post","toPromise","getRefreshParams","refreshToken","HttpParams","set","secret","clientSecret","getAccessTokenParams","actualKeycloakConfig","getTokenRequestHeaders","headers","HttpHeaders","btoa","tokens","isValidToken","getTokenUrl","refresh_token","authServerUrl","realm","initKeycloakInstance","adapter","createLoginUrl","createRegisterUrl","sub","message","console","log","decorators","type","HttpClient","BrowserTab","Router","InAppBrowser","KcTokenInterceptorService","keycloakAuthService","_super","initTokenGetter","__","constructor","tslib_1.__extends","tokenGetter","JwtInterceptor","IonicKeycloakAuthModule","platform","authService","parentModule","Error","ready","forRoot","ngModule","providers","NativeStorage","HttpClientModule","kcOptionsProvider","provide","useValue","jwtConfigProvider","jwtModuleOptions","deepLinksConfig","HTTP_INTERCEPTORS","useClass","multi","NgModule","Platform","Optional","SkipSelf"],"mappings":"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","sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)\r\n            t[p[i]] = s[p[i]];\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator], i = 0;\r\n    if (m) return m.call(o);\r\n    return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {InjectionToken} from '@angular/core';\n\nexport const DEEP_LINKING_OPTIONS = new InjectionToken('DEEP_LINKING_OPTIONS');\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {InjectionToken} from '@angular/core';\n\nexport const JWT_GET_AND_SETTER = new InjectionToken('JWT_GET_AND_SETTER');\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {InjectionToken} from '@angular/core';\n\nexport const KEYCLOAK_OPTIONS = new InjectionToken('KEYCLOAK_OPTIONS');\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nexport class DeepLinkConfig {\n  deepLinkingScheme: string;\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {KeycloakJsonStructure} from './keycloak-json-structure';\n\nexport declare type FetchKeycloakJSON = () => KeycloakJsonStructure | Promise<KeycloakJsonStructure>;\n\nexport class KcConfig {\n  /**\n   * The same as the contain of the keycloak.json\n   * Example: jsonConfig: () => require('/path/to/keycloak.json')\n   */\n  jsonConfig?: FetchKeycloakJSON;\n\n  /**\n   * Example: scope='openid email offline_access address profile', the value would be\n   * 'openid email offline_access address profile' here\n   */\n  scope?: string;\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {Provider} from '@angular/core';\nimport {KcConfig} from './kc-config';\nimport {DeepLinkConfig} from './deep-link-config';\nimport {JwtConfig} from './jwt-config';\n\nexport class ModuleConfig {\n  kcOptionsProvider?: Provider;\n  jwtConfigProvider?: Provider;\n\n  keycloakConfig?: KcConfig;\n  deepLinksConfig: DeepLinkConfig;\n  jwtModuleOptions?: JwtConfig;\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {Injectable} from '@angular/core';\nimport {Subject} from 'rxjs';\nimport {filter} from 'rxjs/operators';\nimport {DeeplinkMatch, Deeplinks} from '@ionic-native/deeplinks/ngx';\nimport {NavController} from '@ionic/angular';\nimport {KeyValueStr} from '../model/key-value-str';\n\n@Injectable()\nexport class DeepLinkService {\n\n  private paramsSubject = new Subject<string>();\n\n  constructor(private navController: NavController,\n              private deepLinks: Deeplinks) {\n  }\n\n  params() {\n    return this.paramsSubject\n      .pipe(filter(str => !!str));\n  }\n\n  init() {\n    this.deepLinks\n      .route({})\n      .subscribe(\n        (match: DeeplinkMatch) => {\n          // match.$route - the route we matched, which is the matched entry from the arguments to route()\n          // match.$args - the args passed in the link\n          // match.$link - the full link data\n          this.extractData(match.$link);\n        },\n        nomatch => {\n          // nomatch.$link - the full link data\n          this.extractData(nomatch.$link);\n        }\n      );\n  }\n\n  private extractData($link) {\n    if ($link) {\n      const {path, fragment, host, scheme, url} = $link;\n      if (this.containsCode(fragment)) {\n        const extractCode = this.extractCode(fragment);\n        this.nextParams(extractCode.code);\n      }\n    }\n  }\n\n  private extractCode(url: string) {\n    const hashes = url.slice(url.indexOf('?') + 1).split('&');\n    const paramsObj = hashes.reduce((params, hash) => {\n      const [key, val] = hash.split('=');\n      return Object.assign(params, {[key]: decodeURIComponent(val)});\n    }, {} as KeyValueStr);\n    if ((!paramsObj) || (!paramsObj.code)) {\n      return;\n    }\n    paramsObj.code = (paramsObj.code as string).split('#')[0];\n    return paramsObj;\n  }\n\n  private nextParams(code: string) {\n    this.paramsSubject.next(code);\n  }\n\n  private containsCode(fragment: string) {\n    if (!fragment) {\n      return false;\n    }\n    return fragment.indexOf('code') > -1;\n  }\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {Inject, Injectable} from '@angular/core';\nimport {JwtConfig} from '../model/jwt-config';\nimport {AuthToken} from '../model/auth-token';\nimport {JWT_GET_AND_SETTER} from '../contant/jwt-injection-token';\n\n@Injectable()\nexport class StorageService {\n\n  constructor(\n    @Inject(JWT_GET_AND_SETTER) private config: JwtConfig,\n  ) {\n  }\n\n  public async setToken(value: AuthToken): Promise<void> {\n    return this.config.setToken(value);\n  }\n\n  public async getToken(): Promise<AuthToken> {\n    return this.config.getToken();\n  }\n\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {Inject, Injectable} from '@angular/core';\nimport {HttpClient, HttpHeaders, HttpParams} from '@angular/common/http';\nimport {DeepLinkService} from './deep-link.service';\nimport {StorageService} from './storage.service';\nimport {BrowserTab} from '@ionic-native/browser-tab/ngx';\nimport {JwtHelperService} from '@auth0/angular-jwt';\nimport {BehaviorSubject, Observable} from 'rxjs';\nimport * as Keycloak_ from 'keycloak-js';\nimport {KeycloakLoginOptions} from 'keycloak-js';\nimport {InAppBrowser} from '@ionic-native/in-app-browser/ngx';\nimport {Router} from '@angular/router';\nimport {IDTokenDecoded} from '../model/id-token-decoded';\nimport {FetchKeycloakJSON, KcConfig} from '../model/kc-config';\nimport {KeycloakJsonStructure} from '../model/keycloak-json-structure';\nimport {DeepLinkConfig} from '../model/deep-link-config';\nimport {AuthToken} from '../model/auth-token';\nimport {TokenDecoded} from '../model/token-decoded';\nimport {KeycloakLoginResponse} from '../model/keycloak-login-response';\nimport {KEYCLOAK_OPTIONS} from '../contant/kc-injection-token';\nimport {DEEP_LINKING_OPTIONS} from '../contant/deep-linking-config-injection-token';\n\n// Workaround from https://github.com/ng-packagr/ng-packagr/issues/343#issuecomment-350965445\nconst Keycloak = Keycloak_;\nconst jwtHelperService: JwtHelperService = new JwtHelperService();\n\n@Injectable()\nexport class KeycloakAuthService {\n\n  private subject: BehaviorSubject<IDTokenDecoded>;\n  private scope: string;\n  private readonly appPrefix: string;\n  private readonly keycloakConfig: FetchKeycloakJSON;\n  private actualKeycloakConfig: KeycloakJsonStructure;\n  private keycloakInstance: Keycloak_.KeycloakInstance;\n\n  constructor(\n    @Inject(DEEP_LINKING_OPTIONS) deepLinkConfig: DeepLinkConfig,\n    @Inject(KEYCLOAK_OPTIONS) kcConfig: KcConfig,\n    protected http: HttpClient,\n    protected browserTab: BrowserTab,\n    protected router: Router,\n    protected storage: StorageService,\n    protected inAppBrowser: InAppBrowser,\n    protected deepLinkService: DeepLinkService,\n  ) {\n    this.scope = kcConfig.scope;\n    this.keycloakConfig = kcConfig.jsonConfig;\n    this.appPrefix = `${deepLinkConfig.deepLinkingScheme}://app`;\n  }\n\n  /**\n   *\n   */\n  public user(): Observable<IDTokenDecoded> {\n    if (!this.subject) {\n      this.subject = new BehaviorSubject<IDTokenDecoded>(null);\n    }\n    return this.subject.asObservable();\n  }\n\n  /**\n   *\n   */\n  public async init() {\n    await this.initKeycloak();\n    return this.refresh();\n  }\n\n  /**\n   *\n   */\n  public async logout() {\n    await this.handleNewToken(null);\n    const url: string = this.getLogoutUrl();\n    return new Promise<void>(async (resolve, reject) => {\n      if (await this.browserTab.isAvailable()) {\n        this.browserTab.openUrl(url)\n          .then(() => this.browserTab.close())\n          .catch(err => reject(err));\n        resolve();\n      } else {\n        const browser = this.inAppBrowser.create(url, '_system');\n        const sub = browser.on('loadstop')\n          .subscribe(() => {\n            browser.close();\n            resolve();\n            sub.unsubscribe();\n          }, err => {\n            reject(err);\n            sub.unsubscribe();\n          });\n      }\n    });\n  }\n\n  /**\n   *\n   * @param isLogin\n   * @param redirectUrl\n   */\n  public async login(isLogin: boolean = true, redirectUrl?: string): Promise<AuthToken> {\n    try {\n      if (redirectUrl[0] === '/') {\n        redirectUrl = redirectUrl.substr(1);\n      }\n      const response = await this.beginLoginAndGetCode(redirectUrl, isLogin);\n      return this.continueLoginWithCode(response);\n    } catch (err) {\n      const context = {messageError: 'Ionic Keycloak Error: error by login'};\n      Object.assign(err, {context});\n      throw err;\n    }\n  }\n\n\n  /**\n   *\n   * @param refresh\n   */\n  public async getToken(refresh = false) {\n    let authToken = await this.storage.getToken();\n    if (!authToken) {\n      return null;\n    }\n    if (refresh || jwtHelperService.isTokenExpired(authToken.access_token, 10)) {\n      authToken = await this.refresh();\n    }\n    return authToken.access_token;\n  }\n\n  public async getTokenDecoded(refresh = false): Promise<TokenDecoded> {\n    const token = await this.getToken(refresh);\n    return jwtHelperService.decodeToken(token) as TokenDecoded;\n  }\n\n  private getLogoutUrl(redirectUrl = this.router.url): string {\n    return this.keycloakInstance.createLogoutUrl({\n      redirectUri: this.appPrefix + encodeURIComponent(redirectUrl)\n    });\n  }\n\n  private async getKcJsonStructure(): Promise<KeycloakJsonStructure> {\n    const prom = this.keycloakConfig();\n    let config: KeycloakJsonStructure;\n    if (prom instanceof Promise) {\n      config = await prom;\n    } else {\n      config = prom;\n    }\n    /**\n     * This line because the init method needs the clientId and url to work\n     * which are the resource and the auth-server-url respectively\n     */\n    config.clientId = config.resource;\n    config.url = config['auth-server-url'];\n    return config;\n  }\n\n  private async handleNewToken(authToken: AuthToken) {\n    if (authToken) {\n      const user: IDTokenDecoded = jwtHelperService.decodeToken(authToken.id_token || authToken.access_token);\n      if (!this.subject) {\n        this.subject = new BehaviorSubject<IDTokenDecoded>(user);\n      }\n      this.subject.next(user);\n      await this.storage.setToken(authToken);\n    } else {\n      if (!this.subject) {\n        this.subject = new BehaviorSubject<IDTokenDecoded>(null);\n      }\n      this.subject.next(null);\n      await this.storage.setToken(null);\n    }\n  }\n\n  private createPostRequest(uri: string, body: any, options?: {\n    headers?: HttpHeaders | {\n      [header: string]: string | string[];\n    };\n  }) {\n    return this.http.post<AuthToken>(uri, body, options).toPromise();\n  }\n\n  private getRefreshParams(refreshToken: string) {\n    const params = new HttpParams()\n      .set('grant_type', 'refresh_token')\n      .set('refresh_token', refreshToken)\n      .set('client_id', encodeURIComponent(this.keycloakInstance.clientId));\n    const secret = this.keycloakInstance.clientSecret;\n    if (secret) {\n      return params\n        .set('client_secret', encodeURIComponent(secret));\n    }\n    return params;\n  }\n\n  private getAccessTokenParams(code: string, redirectUrl: string) {\n    let redirectUri = new HttpParams()\n      .set('grant_type', 'authorization_code')\n      .set('code', code)\n      .set('client_id', encodeURIComponent(this.keycloakInstance.clientId))\n      .set('redirect_uri', redirectUrl);\n    if (this.scope || (this.actualKeycloakConfig && this.actualKeycloakConfig.scope)) {\n      redirectUri = redirectUri.set('scope', this.scope || this.actualKeycloakConfig.scope);\n    }\n\n    const secret = this.keycloakInstance.clientSecret;\n    if (secret) {\n      redirectUri = redirectUri.set('client_secret', encodeURIComponent(secret));\n    }\n    return redirectUri;\n  }\n\n  private getTokenRequestHeaders() {\n    const headers = new HttpHeaders()\n      .set('Content-Type', 'application/x-www-form-urlencoded');\n\n    const clientSecret = this.keycloakInstance.clientSecret;\n    const clientId = this.keycloakInstance.clientId;\n    if (clientId && clientSecret) {\n      headers.set('Authorization', 'Basic ' + btoa(clientId + ':' + clientSecret));\n    }\n    return headers;\n  }\n\n  private async refresh(): Promise<AuthToken> {\n    try {\n      let tokens: AuthToken = await this.storage.getToken();\n      if (tokens) {\n        if (!this.isValidToken(tokens)) {\n          const uri = this.getTokenUrl();\n          const headers = this.getTokenRequestHeaders();\n          const body = this.getRefreshParams(tokens.refresh_token);\n          tokens = await this.createPostRequest(uri, body, {headers});\n        }\n      }\n      this.handleNewToken(tokens);\n      return tokens;\n    } catch (e) {\n      await this.logout();\n      return null;\n    }\n  }\n\n  private getTokenUrl() {\n    return `${this.keycloakInstance.authServerUrl}/realms/${this.keycloakInstance.realm}/protocol/openid-connect/token`;\n  }\n\n  private isValidToken(authToken: AuthToken) {\n    if (!authToken) {\n      return false;\n    }\n    return jwtHelperService.isTokenExpired(authToken.access_token, 10);\n  }\n\n  private async initKeycloakInstance() {\n    const keycloakConfig = await this.getKcJsonStructure();\n    this.actualKeycloakConfig = keycloakConfig;\n    this.keycloakInstance = Keycloak(keycloakConfig);\n  }\n\n  private async initKeycloak() {\n    await this.initKeycloakInstance();\n\n    this.keycloakInstance\n      .init({\n        adapter: 'cordova-native',\n        redirectUri: this.appPrefix + '/'\n      });\n  }\n\n  private async beginLoginAndGetCode(path: string, login = true): Promise<KeycloakLoginResponse> {\n    path = `${this.appPrefix}/${path}`;\n    await this.storage.setToken(null);\n\n    const options: KeycloakLoginOptions = {\n      redirectUri: path\n    };\n    const url: string = login\n      ? this.keycloakInstance.createLoginUrl(options)\n      : this.keycloakInstance.createRegisterUrl(options);\n\n    if (await this.browserTab.isAvailable()) {\n      this.browserTab.openUrl(url);\n    } else {\n      this.inAppBrowser.create(url, '_system');\n    }\n\n    return new Promise<KeycloakLoginResponse>((resolve, reject) => {\n      const sub = this.deepLinkService\n        .params()\n        .subscribe(code => {\n          resolve({code, redirectUri: path});\n          sub.unsubscribe();\n        }, error => {\n          reject(error);\n          sub.unsubscribe();\n        });\n    });\n  }\n\n  private async continueLoginWithCode({code, redirectUri: redirectUrl}: KeycloakLoginResponse): Promise<AuthToken> {\n    this.browserTab.close()\n      .catch((err = {}) => {\n        const context = {message: 'Error while closing the browser'};\n        console.log(context.message, err);\n        Object.assign(err, {context});\n        throw err;\n      });\n    const uri = this.getTokenUrl();\n    const body = this.getAccessTokenParams(code, redirectUrl);\n    const headers = this.getTokenRequestHeaders();\n    return this.createPostRequest(uri, body, {headers})\n      .then(async authToken => {\n        this.handleNewToken(authToken);\n        return authToken;\n      });\n  }\n\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {Inject, Injectable} from '@angular/core';\nimport {JwtHelperService, JwtInterceptor} from '@auth0/angular-jwt';\nimport {KeycloakAuthService} from './keycloak-auth.service';\nimport {JwtConfig} from '../model/jwt-config';\nimport {JWT_GET_AND_SETTER} from '../contant/jwt-injection-token';\n\n@Injectable()\nexport class KcTokenInterceptorService extends JwtInterceptor {\n\n  constructor(\n    @Inject(JWT_GET_AND_SETTER) private config: JwtConfig,\n    private keycloakAuthService: KeycloakAuthService\n  ) {\n    super(config, new JwtHelperService());\n    this.initTokenGetter();\n  }\n\n  private initTokenGetter() {\n    this.tokenGetter = () => this.keycloakAuthService.getToken();\n  }\n\n}\n","/*\n * Copyright (c) 2019. This Code is under license and belongs to Coding Motion\n */\n\nimport {ModuleWithProviders, NgModule, Optional, SkipSelf} from '@angular/core';\nimport {Platform} from '@ionic/angular';\nimport {NativeStorage} from '@ionic-native/native-storage/ngx';\nimport {BrowserTab} from '@ionic-native/browser-tab/ngx';\nimport {JwtHelperService} from '@auth0/angular-jwt';\nimport {HTTP_INTERCEPTORS, HttpClientModule} from '@angular/common/http';\nimport {Deeplinks} from '@ionic-native/deeplinks/ngx';\nimport {InAppBrowser} from '@ionic-native/in-app-browser/ngx';\nimport {DeepLinkService} from './service/deep-link.service';\nimport {KeycloakAuthService} from './service/keycloak-auth.service';\nimport {StorageService} from './service/storage.service';\nimport {KcTokenInterceptorService} from './service/kc-token-interceptor.service';\nimport {ModuleConfig} from './model/module-config';\nimport {JWT_GET_AND_SETTER} from './contant/jwt-injection-token';\nimport {KEYCLOAK_OPTIONS} from './contant/kc-injection-token';\nimport {DEEP_LINKING_OPTIONS} from './contant/deep-linking-config-injection-token';\n\n@NgModule()\nexport class IonicKeycloakAuthModule {\n\n  constructor(\n    private platform: Platform,\n    private authService: KeycloakAuthService,\n    private deepLinkService: DeepLinkService,\n    @Optional() @SkipSelf() parentModule: IonicKeycloakAuthModule\n  ) {\n    if (parentModule) {\n      throw new Error('JwtModule is already loaded. It should only be imported in your application\\'s main module.');\n    }\n    this.platform\n      .ready()\n      .then(() => this.authService.init())\n      .then(() => this.deepLinkService.init())\n      .catch((err = {}) => {\n        const context = {messageError: 'Ionic Keycloak Error: could not initialize the app'};\n        Object.assign(err, {context});\n        throw err;\n      });\n  }\n\n  public static forRoot(config = new ModuleConfig()): ModuleWithProviders {\n    return {\n      ngModule: IonicKeycloakAuthModule,\n      providers: [\n        Deeplinks,\n        BrowserTab,\n        InAppBrowser,\n        NativeStorage,\n        HttpClientModule,\n        config.kcOptionsProvider || {provide: KEYCLOAK_OPTIONS, useValue: config.keycloakConfig},\n        config.jwtConfigProvider || {provide: JWT_GET_AND_SETTER, useValue: config.jwtModuleOptions},\n        {provide: DEEP_LINKING_OPTIONS, useValue: config.deepLinksConfig},\n        StorageService,\n        DeepLinkService,\n        KeycloakAuthService,\n        JwtHelperService,\n        {\n          provide: HTTP_INTERCEPTORS,\n          useClass: KcTokenInterceptorService,\n          multi: true\n        },\n      ]\n    };\n  }\n\n}\n\n"]}